# ReUntangle - システムアーキテクチャ

## 概要
ReUntangleは、完全にクライアントサイドで動作するWebアプリケーションです。すべての処理はブラウザ内で完結し、ユーザーのファイルデータは外部に送信されません。

---

## アーキテクチャ概要図

```
┌─────────────────────────────────────────────────────────┐
│                      Browser (Client)                    │
│                                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Presentation Layer                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │
│  │  │  Next.js  │  │ @xyflow/ │  │ Tailwind │     │   │
│  │  │  Pages    │  │  react   │  │   CSS    │     │   │
│  │  └──────────┘  └──────────┘  └──────────┘     │   │
│  └─────────────────────────────────────────────────┘   │
│                          ↓                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Application Layer                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │
│  │  │  Custom   │  │  State   │  │ Business │     │   │
│  │  │  Hooks    │  │ Management│ │  Logic   │     │   │
│  │  └──────────┘  └──────────┘  └──────────┘     │   │
│  └─────────────────────────────────────────────────┘   │
│                          ↓                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │               Service Layer                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │
│  │  │  Parser   │  │  Graph   │  │ Analysis │     │   │
│  │  │  Engine   │  │ Builder  │  │  Engine  │     │   │
│  │  └──────────┘  └──────────┘  └──────────┘     │   │
│  └─────────────────────────────────────────────────┘   │
│                          ↓                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Data Access Layer                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │   │
│  │  │File System│ │ Browser  │  │  Cache   │     │   │
│  │  │Access API │  │ Storage  │  │  Layer   │     │   │
│  │  └──────────┘  └──────────┘  └──────────┘     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────┘
                          ↓
              ┌──────────────────────┐
              │   Local File System  │
              └──────────────────────┘
```

---

## レイヤー構成

### 1. Presentation Layer（プレゼンテーション層）

#### 責務
- ユーザーインターフェースの表示
- ユーザー操作の受付
- データの視覚的表現

#### 主要コンポーネント
- **Next.js Pages**: ルーティングとページ管理
- **React Components**: UI部品
- **@xyflow/react**: グラフ可視化
- **Tailwind CSS**: スタイリング

#### 技術
- Next.js 15.5+ (App Router)
- React 19.1+
- @xyflow/react 12.8+
- Tailwind CSS 3.4+

---

### 2. Application Layer（アプリケーション層）

#### 責務
- アプリケーション状態の管理
- ビジネスロジックの調整
- 各レイヤー間の橋渡し

#### 主要要素
- **Custom Hooks**: 再利用可能なロジック
  - `useFileSystem`: ファイル操作
  - `useParser`: 解析処理
  - `useGraph`: グラフ操作
- **State Management**: アプリケーション状態
  - React Context API
  - ローカルステート（useState）
- **Business Logic**: ビジネスルール
  - バリデーション
  - データ変換
  - エラーハンドリング

---

### 3. Service Layer（サービス層）

#### 責務
- コア機能の提供
- データ処理と解析
- グラフデータの生成

#### Parser Engine（解析エンジン）

**機能**:
- ファイルスキャン
- AST（抽象構文木）解析
- 依存関係抽出

**使用ライブラリ**:
- `@babel/parser`: コードのパース
- `@babel/traverse`: AST走査

**処理フロー**:
```
ファイル読み込み
    ↓
AST生成
    ↓
import文解析
    ↓
コンポーネント特定
    ↓
依存関係抽出
```

#### Graph Builder（グラフ構築）

**機能**:
- ノード/エッジデータの生成
- レイアウト計算
- グラフ最適化

**処理フロー**:
```
依存関係データ
    ↓
ノード生成
    ↓
エッジ生成
    ↓
レイアウト計算
    ↓
React Flowフォーマット
```

#### Analysis Engine（分析エンジン）

**機能**:
- 複雑度計算
- 循環依存検出
- メトリクス算出

**分析項目**:
- コンポーネント複雑度
- 依存の深さ
- 警告・推奨事項

---

### 4. Data Access Layer（データアクセス層）

#### 責務
- ローカルファイルシステムへのアクセス
- ブラウザストレージの管理
- キャッシング

#### File System Access

**API**: File System Access API
**操作**:
- ディレクトリ選択
- ファイル読み込み
- 再帰的スキャン

**セキュリティ**:
- ユーザー明示的な許可が必要
- 読み取り専用
- データ非送信

#### Browser Storage

**使用技術**:
- LocalStorage: 設定の永続化
- SessionStorage: 一時データ

**保存データ**:
- レイアウト設定
- フィルタ設定
- 最後に開いたプロジェクトパス（パスのみ、内容は保存しない）

#### Cache Layer

**キャッシュ対象**:
- 解析済みAST
- グラフデータ
- 計算済みメトリクス

**キャッシュ戦略**:
- メモリキャッシュ（セッション中のみ）
- ファイルハッシュベースの無効化

---

## データフロー

### 解析フロー

```
1. ユーザーがフォルダを選択
         ↓
2. File System Access APIでファイル一覧取得
         ↓
3. React/TSファイルをフィルタリング
         ↓
4. 各ファイルを並行して解析
   - AST生成
   - import文抽出
   - コンポーネント特定
         ↓
5. 依存関係グラフを構築
   - ノード生成
   - エッジ生成
         ↓
6. 分析実行
   - 複雑度計算
   - 警告検出
         ↓
7. React Flowフォーマットに変換
         ↓
8. UI表示
```

### インタラクションフロー

```
ユーザー操作（クリック、ズームなど）
         ↓
イベントハンドラー
         ↓
状態更新（React State）
         ↓
再レンダリング
         ↓
UI更新
```

---

## 技術スタック詳細

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 15.5+ | フレームワーク |
| React | 19.1+ | UIライブラリ |
| TypeScript | 5.9+ | 型安全性 |
| Tailwind CSS | 3.4+ | スタイリング |

### グラフ可視化

| 技術 | バージョン | 用途 |
|------|-----------|------|
| @xyflow/react | 12.8+ | グラフ描画 |
| D3.js (optional) | 7+ | 補助的な計算 |

### コード解析

| 技術 | バージョン | 用途 |
|------|-----------|------|
| @babel/parser | 7.25+ | コードパース |
| @babel/traverse | 7.25+ | AST走査 |
| @babel/types | 7.25+ | AST型定義 |

### ユーティリティ

| 技術 | バージョン | 用途 |
|------|-----------|------|
| lodash | 4+ | ユーティリティ関数 |
| fflate | 0.8+ | ファイル圧縮（将来） |

---

## セキュリティアーキテクチャ

### データプライバシー

**原則**:
1. データは外部に送信しない
2. ファイル内容はメモリ上でのみ処理
3. 永続化するのは設定のみ（ファイル内容は保存しない）

**実装**:
- すべての処理がクライアントサイド
- サーバーサイドコンポーネントなし
- 外部APIコールなし

### ブラウザセキュリティ

**File System Access API**:
- ユーザーの明示的な許可が必要
- Origin単位でのアクセス制御
- 読み取り専用アクセス

**Content Security Policy**:
- 信頼できるソースのみ許可
- inline scriptの制限
- XSS対策

---

## パフォーマンス最適化

### 解析の最適化

**並列処理**:
- Web Workersでファイル解析を並列化
- メインスレッドをブロックしない

**遅延ロード**:
- 必要なファイルのみ解析
- 大規模プロジェクトでは段階的に処理

**キャッシング**:
- 解析結果をメモリキャッシュ
- ファイルハッシュで変更検出

### レンダリングの最適化

**仮想化**:
- 表示領域のノードのみレンダリング
- 大規模グラフでもスムーズ

**メモ化**:
- React.memo でコンポーネント最適化
- useMemo でコストの高い計算をキャッシュ

**デバウンス**:
- 検索・フィルタリング処理
- ズーム・パン操作

---

## スケーラビリティ

### プロジェクトサイズ対応

| プロジェクトサイズ | コンポーネント数 | 対応策 |
|------------------|----------------|--------|
| 小規模 | 〜50 | 標準処理 |
| 中規模 | 51〜200 | 並列処理 |
| 大規模 | 201〜500 | 並列処理 + 仮想化 |
| 超大規模 | 501〜 | 並列処理 + 仮想化 + フィルタリング推奨 |

### 将来の拡張性

**プラグインアーキテクチャ（将来）**:
- カスタム解析ルール
- カスタムレイアウトアルゴリズム
- カスタムメトリクス

**マルチフレームワーク対応（将来）**:
- Vue.js解析エンジン
- Angular解析エンジン
- プラガブルな設計

---

## エラーハンドリング

### エラー分類

**ユーザーエラー**:
- 不正なフォルダ選択
- 権限エラー
→ ユーザーフレンドリーなメッセージ表示

**パースエラー**:
- 構文エラーのあるファイル
- サポート外の構文
→ スキップして処理継続、ログ記録

**システムエラー**:
- メモリ不足
- ブラウザAPI非対応
→ エラー画面表示、リカバリー提案

### エラー境界

**React Error Boundary**:
- コンポーネントレベルでのエラー捕捉
- グレースフルなフォールバック表示
- エラーログの記録

---

## 監視とログ

### ログレベル

- **ERROR**: 致命的エラー
- **WARN**: 警告（処理は継続）
- **INFO**: 情報（解析開始/終了など）
- **DEBUG**: デバッグ情報（開発時のみ）

### パフォーマンス計測

- 解析時間
- レンダリング時間
- メモリ使用量
- ユーザー操作のレスポンス時間

---

## デプロイメント

### ビルド構成

**開発環境**:
```bash
npm run dev
```
- Hot Reload
- ソースマップ
- 詳細なエラー表示

**本番環境**:
```bash
npm run build
npm run start
```
- コード最小化
- 最適化
- 圧縮

### ホスティング

**推奨プラットフォーム**:
- Vercel（Next.js開発元）
- Netlify
- Cloudflare Pages

**要件**:
- 静的ホスティング対応
- HTTPSサポート
- CDN配信

---

## まとめ

ReUntangleは、完全にクライアントサイドで動作するシンプルかつ強力なアーキテクチャを採用しています。

**主要な設計原則**:
1. **プライバシー第一**: データを外部に送信しない
2. **レイヤー分離**: 明確な責任分担
3. **パフォーマンス重視**: 大規模プロジェクトにも対応
4. **拡張性**: 将来の機能追加を考慮

---

**作成日**: 2025年10月17日  
**バージョン**: 1.0